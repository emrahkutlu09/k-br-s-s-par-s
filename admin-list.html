<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Paneli</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 20px;
    }
    .cikis-btn, .excel-butonu {
      float: right;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
    h2 {
      text-align: center;
      margin-bottom: 40px;
    }
    .filtreler {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
      flex-wrap: wrap;
    }
    input[type="date"], input[type="text"] {
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .siparis-kart {
      background-color: white;
      border: 1px solid #ccc;
      border-left: 6px solid #198754;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .siparis-kart p {
      margin: 5px 0;
    }
    .sil, .durum-secim {
      margin-top: 8px;
    }
    .sil {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .toplam-tutar {
      margin-top: 20px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>
<script>
  if (localStorage.getItem("girisYapildi") !== "true") {
    window.location.href = "admin-login.html";
  }
</script>

<button class="excel-butonu">Excel'e Aktar</button>
<button class="cikis-btn" onclick="cikisYap()">Çıkış Yap</button>
<h2>📋 Sipariş Listesi</h2>

<div class="filtreler">
  <input type="text" id="arama" placeholder="🔍 Siparişlerde Ara">
  <input type="date" id="tarih1">
  <input type="date" id="tarih2">
</div>

<div id="siparisKutulari"></div>
<div class="toplam-tutar" id="toplamTutar"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
    authDomain: "kibrissiparissistemi.firebaseapp.com",
    projectId: "kibrissiparissistemi",
    storageBucket: "kibrissiparissistemi.firebasestorage.app",
    messagingSenderId: "263531733235",
    appId: "1:263531733235:web:82efdf39ed758a22465786",
    measurementId: "G-JK5S6L90Q5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const konteyner = document.getElementById("siparisKutulari");
  const toplamTutarDiv = document.getElementById("toplamTutar");

  function cikisYap() {
    localStorage.removeItem("girisYapildi");
    window.location.href = "admin-login.html";
  }

  document.getElementById("arama").addEventListener("input", filtrele);
  document.getElementById("tarih1").addEventListener("change", filtrele);
  document.getElementById("tarih2").addEventListener("change", filtrele);

  function filtrele() {
    const aranan = document.getElementById("arama").value.toLowerCase();
    const t1 = new Date(document.getElementById("tarih1").value);
    const t2 = new Date(document.getElementById("tarih2").value);
    const kartlar = document.querySelectorAll(".siparis-kart");

    kartlar.forEach(kart => {
      const icerik = kart.innerText.toLowerCase();
      const tarihStr = kart.getAttribute("data-tarih");
      const tarih = new Date(tarihStr);
      const uygunTarih = (!isNaN(t1) ? tarih >= t1 : true) && (!isNaN(t2) ? tarih <= t2 : true);
      kart.style.display = icerik.includes(aranan) && uygunTarih ? "block" : "none";
    });
  }

  function siparisleriGetir() {
    db.collection("siparisler").onSnapshot(snapshot => {
      konteyner.innerHTML = "";
      let toplam = 0;

      snapshot.forEach(doc => {
        const d = doc.data();
        const tarihStr = d.tarih || new Date().toISOString().split("T")[0];
        const fiyat = parseFloat(d.ucret) || 0;
        toplam += fiyat;

        const div = document.createElement("div");
        div.className = "siparis-kart";
        div.setAttribute("data-tarih", tarihStr);

        div.innerHTML = `
          <p><strong>📦 Sipariş:</strong> ${d.siparisKodu}</p>
          <p><strong>🔗 Ürün:</strong> <a href="${d.urunLink}" target="_blank">Linke Git</a></p>
          <p><strong>💰 Fiyat:</strong> ${d.ucret} ₺</p>
          <p><strong>📁 Kategori:</strong> ${d.kategori}</p>
          <p><strong>🚚 Teslimat:</strong> ${d.teslimat}</p>
          <p><strong>📅 Tarih:</strong> ${tarihStr}</p>
          <select class="durum-secim" onchange="durumGuncelle('${doc.id}', this.value)">
            <option ${d.durum === "Hazırlanıyor" ? "selected" : ""}>Hazırlanıyor</option>
            <option ${d.durum === "Kargoda" ? "selected" : ""}>Kargoda</option>
            <option ${d.durum === "Teslim Edildi" ? "selected" : ""}>Teslim Edildi</option>
          </select>
          <br><button class="sil" onclick="sil('${doc.id}')">Sil</button>
        `;

        konteyner.appendChild(div);
      });
      toplamTutarDiv.textContent = `💳 Toplam Tutar: ${toplam.toFixed(2)} ₺`;
    });
  }

  function durumGuncelle(id, durum) {
    db.collection("siparisler").doc(id).update({ durum });
  }

  function sil(id) {
    if (confirm("Bu siparişi silmek istediğinize emin misiniz?")) {
      db.collection("siparisler").doc(id).delete();
    }
  }

  document.querySelector(".excel-butonu").addEventListener("click", function () {
    const kartlar = document.querySelectorAll(".siparis-kart");
    const veri = [];

    kartlar.forEach(kart => {
      if (kart.style.display === "none") return;
      const satir = {
        Sipariş: kart.querySelector("strong").nextSibling.textContent.trim(),
        Fiyat: kart.innerText.match(/Fiyat: (\d+)/)?.[1] + " ₺" || "",
        Kategori: kart.innerText.match(/Kategori: (.+)/)?.[1] || "",
        Teslimat: kart.innerText.match(/Teslimat: (.+)/)?.[1] || "",
        Tarih: kart.getAttribute("data-tarih")
      };
      veri.push(satir);
    });

    const ws = XLSX.utils.json_to_sheet(veri);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Siparişler");
    XLSX.writeFile(wb, "siparisler.xlsx");
  });

  siparisleriGetir();
</script>
</body>
</html>
