<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Admin Sipariş Paneli</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f8f9fa;
      padding: 20px;
    }
    h2 {
      text-align: center;
    }
    .cikis-btn {
      float: right;
      background-color: #6c757d;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .arama-panel {
      margin-bottom: 20px;
    }
    input[type="text"], input[type="date"] {
      padding: 5px;
      margin-right: 10px;
    }
    .siparis-kart {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      background: #fff;
    }
    .sil {
      background-color: red;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <script>
    if (localStorage.getItem("girisYapildi") !== "true") {
      window.location.href = "admin-login.html";
    }
  </script>

  <button class="cikis-btn" onclick="cikisYap()">Çıkış Yap</button>
  <h2>📋 Sipariş Listesi</h2>

  <div class="arama-panel">
    <input type="text" id="arama" placeholder="🔍 Sipariş ara...">
    <input type="date" id="tarih1">
    <input type="date" id="tarih2">
    <button class="excel-butonu">📤 Excel’e Aktar</button>
    <div id="toplamTutar">Toplam: 0 ₺</div>
  </div>

  <div id="siparisAlani"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBCbKtD6jPE653IYwtTWo2fH93JXX4MN74",
      authDomain: "kibrissiparissistemi.firebaseapp.com",
      projectId: "kibrissiparissistemi",
      storageBucket: "kibrissiparissistemi.firebasestorage.app",
      messagingSenderId: "263531733235",
      appId: "1:263531733235:web:82efdf39ed758a22465786",
      measurementId: "G-JK5S6L90Q5"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const siparisAlani = document.getElementById("siparisAlani");

    function verileriYukle() {
      db.collection("siparisler").orderBy("tarih", "desc").onSnapshot(snapshot => {
        siparisAlani.innerHTML = "";
        let toplam = 0;

        snapshot.forEach(doc => {
          const data = doc.data();
          if (!tarihUygunMu(data.tarih)) return;

          toplam += parseFloat(data.ucret || 0);

          const kart = document.createElement("div");
          kart.className = "siparis-kart";
          kart.innerHTML = `
            <strong>Kod:</strong> ${data.siparisKodu || "-"}<br>
            <strong>Link:</strong> <a href="${data.urunLink || "#"}" target="_blank">link</a><br>
            <strong>Fiyat:</strong> ${data.ucret || 0} ₺<br>
            <strong>Kategori:</strong> ${data.kategori || "-"}<br>
            <strong>Teslimat:</strong> ${data.teslimat || "-"}<br>
            <strong>Durum:</strong>
            <select onchange="durumGuncelle('${doc.id}', this.value)">
              <option ${data.durum === "Hazırlanıyor" ? "selected" : ""}>Hazırlanıyor</option>
              <option ${data.durum === "Yolda" ? "selected" : ""}>Yolda</option>
              <option ${data.durum === "Teslim Edildi" ? "selected" : ""}>Teslim Edildi</option>
            </select><br>
            <button class="sil" onclick="silSiparis('${doc.id}')">Sil</button>
          `;
          siparisAlani.appendChild(kart);
        });

        document.getElementById("toplamTutar").innerText = `Toplam: ${toplam.toFixed(2)} ₺`;
      });
    }

    function tarihUygunMu(siparisTarihiStr) {
      const t1 = document.getElementById("tarih1").value;
      const t2 = document.getElementById("tarih2").value;
      if (!t1 && !t2) return true;

      const siparisTarihi = new Date(siparisTarihiStr);
      const baslangic = t1 ? new Date(t1) : null;
      const bitis = t2 ? new Date(t2) : null;

      if (baslangic && siparisTarihi < baslangic) return false;
      if (bitis && siparisTarihi > bitis) return false;
      return true;
    }

    function durumGuncelle(id, yeniDurum) {
      db.collection("siparisler").doc(id).update({ durum: yeniDurum });
    }

    function silSiparis(id) {
      if (confirm("Bu siparişi silmek istediğinize emin misiniz?")) {
        db.collection("siparisler").doc(id).delete();
      }
    }

    function cikisYap() {
      localStorage.removeItem("girisYapildi");
      window.location.href = "admin-login.html";
    }

    document.getElementById("arama").addEventListener("input", function () {
      const aranan = this.value.toLowerCase();
      const kartlar = document.querySelectorAll(".siparis-kart");
      kartlar.forEach(kart => {
        const icerik = kart.innerText.toLowerCase();
        kart.style.display = icerik.includes(aranan) ? "block" : "none";
      });
    });

    document.querySelector(".excel-butonu").addEventListener("click", function () {
      const kartlar = document.querySelectorAll(".siparis-kart");
      const data = [];
      kartlar.forEach(kart => {
        const satir = {};
        kart.innerText.split("\n").forEach(item => {
          const [etiket, deger] = item.split(":");
          if (etiket && deger) satir[etiket.trim()] = deger.trim();
        });
        data.push(satir);
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Siparişler");
      XLSX.writeFile(wb, "siparisler.xlsx");
    });

    verileriYukle();
  </script>
</body>
</html>
